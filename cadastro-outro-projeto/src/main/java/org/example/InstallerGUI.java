package org.example;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.io.File;

public class InstallerGUI extends JFrame {
    private JTextArea logArea;
    
    public InstallerGUI() {
        initializeUI();
    }
    
    private void initializeUI() {
        setTitle("Gerenciador do Banco EditPro - Criar/Restaurar");
        setSize(600, 500);
        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);
        setLocationRelativeTo(null);
        
        JPanel mainPanel = new JPanel(new BorderLayout(10, 10));
        mainPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        
        // T√≠tulo
        JLabel tituloLabel = new JLabel("üóÉÔ∏è GERENCIADOR DO BANCO EDITPRO");
        tituloLabel.setFont(new Font("Arial", Font.BOLD, 16));
        tituloLabel.setBorder(BorderFactory.createEmptyBorder(0, 0, 10, 0));
        
        // Painel de informa√ß√µes
        JPanel infoPanel = new JPanel(new BorderLayout(10, 10));
        String serverInfo = ConfigManager.getServerName();
        if (serverInfo == null || serverInfo.isEmpty()) {
            serverInfo = "‚ùå N√£o configurado";
        }
        JLabel infoLabel = new JLabel("Servidor SQL: " + serverInfo);
        infoLabel.setFont(new Font("Arial", Font.BOLD, 12));
        
        JLabel descLabel = new JLabel("Selecione uma opera√ß√£o para gerenciar o banco EditPro:");
        descLabel.setBorder(BorderFactory.createEmptyBorder(5, 0, 10, 0));
        
        infoPanel.add(infoLabel, BorderLayout.NORTH);
        infoPanel.add(descLabel, BorderLayout.CENTER);
        
        // √Årea de log
        logArea = new JTextArea(12, 50);
        logArea.setEditable(false);
        logArea.setBackground(new Color(240, 240, 240));
        logArea.setFont(new Font("Consolas", Font.PLAIN, 11));
        JScrollPane logScroll = new JScrollPane(logArea);
        logScroll.setBorder(BorderFactory.createTitledBorder("Log de Opera√ß√µes"));
        
        // Painel de bot√µes principais
        JPanel buttonPanel = new JPanel(new GridLayout(3, 1, 10, 10));
        buttonPanel.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));
        
        JButton criarDbButton = new JButton("üóÉÔ∏è 1. CRIAR NOVO BANCO EDITPRO");
        criarDbButton.setBackground(new Color(34, 139, 34));
        criarDbButton.setForeground(Color.WHITE);
        criarDbButton.setFont(new Font("Arial", Font.BOLD, 12));
        criarDbButton.addActionListener(this::criarBancoDados);
        
        JButton restaurarButton = new JButton("üíæ 2. RESTAURAR DE BACKUP");
        restaurarButton.setBackground(new Color(70, 130, 180));
        restaurarButton.setForeground(Color.WHITE);
        restaurarButton.setFont(new Font("Arial", Font.BOLD, 12));
        restaurarButton.addActionListener(this::restaurarBackup);
        
        JButton verificarButton = new JButton("üîç 3. VERIFICAR BANCO ATUAL");
        verificarButton.setBackground(new Color(255, 165, 0));
        verificarButton.setForeground(Color.WHITE);
        verificarButton.setFont(new Font("Arial", Font.BOLD, 12));
        verificarButton.addActionListener(this::verificarBanco);
        
        buttonPanel.add(criarDbButton);
        buttonPanel.add(restaurarButton);
        buttonPanel.add(verificarButton);
        
        // Painel inferior com bot√£o voltar
        JPanel bottomPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        JButton voltarButton = new JButton("‚Ü©Ô∏è Voltar para Menu Principal");
        voltarButton.addActionListener(e -> {
            dispose();
            Main.showInitialChoiceDialog();
        });
        bottomPanel.add(voltarButton);
        
        // Montagem do layout
        mainPanel.add(tituloLabel, BorderLayout.NORTH);
        mainPanel.add(infoPanel, BorderLayout.CENTER);
        mainPanel.add(buttonPanel, BorderLayout.SOUTH);
        
        JPanel contentPanel = new JPanel(new BorderLayout(10, 10));
        contentPanel.add(mainPanel, BorderLayout.NORTH);
        contentPanel.add(logScroll, BorderLayout.CENTER);
        contentPanel.add(bottomPanel, BorderLayout.SOUTH);
        
        add(contentPanel);
        
        logMessage("=== GERENCIADOR DO BANCO EDITPRO ===");
        logMessage("Servidor: " + serverInfo);
        logMessage("Pronto para opera√ß√µes.");
        logMessage("Selecione uma op√ß√£o acima.");
    }
    
    private void criarBancoDados(ActionEvent e) {
        String serverName = ConfigManager.getServerName();
        
        if (serverName == null || serverName.isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Servidor SQL n√£o configurado!\n\n" +
                "Configure primeiro a conex√£o com o SQL Server\n" +
                "atrav√©s da op√ß√£o 'Configurar Conex√£o' no menu principal.",
                "Erro de Configura√ß√£o", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        int confirm = JOptionPane.showConfirmDialog(this, 
            "Deseja criar o banco de dados 'EditPro'?\n\n" +
            "üìã SERVIDOR: " + serverName + "\n" +
            "üìä A√á√ÉO: Criar banco EditPro com TODAS as tabelas\n" +
            "‚úÖ TABELAS INCLU√çDAS:\n" +
            "   ‚Ä¢ Visitantes, Historicos, HistoricosVisitados\n" +
            "   ‚Ä¢ Setores, Unidades, Visitados\n\n" +
            "Esta a√ß√£o √© irrevers√≠vel. Continuar?",
            "Confirmar Cria√ß√£o do Banco EditPro", 
            JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
        
        if (confirm == JOptionPane.YES_OPTION) {
            new Thread(() -> {
                try {
                    logMessage("\n" + "=".repeat(50));
                    logMessage("INICIANDO CRIA√á√ÉO DO BANCO EDITPRO");
                    logMessage("=".repeat(50));
                    logMessage("Servidor: " + serverName);
                    logMessage("üì¶ Preparando para criar banco e tabelas...");
                    
                    boolean success = ConnectionFactory.createDatabaseIfNotExists(serverName);
                    
                    SwingUtilities.invokeLater(() -> {
                        if (success) {
                            logMessage("‚úÖ BANCO EDITPRO CRIADO COM SUCESSO!");
                            logMessage("‚úÖ Todas as tabelas foram criadas automaticamente");
                            logMessage("‚úÖ Sistema pronto para uso");
                            
                            JOptionPane.showMessageDialog(this, 
                                "üéâ BANCO EDITPRO CRIADO COM SUCESSO!\n\n" +
                                "Todas as tabelas foram criadas:\n" +
                                "‚Ä¢ Visitantes, Historicos, HistoricosVisitados\n" +
                                "‚Ä¢ Setores, Unidades, Visitados\n\n" +
                                "O sistema est√° pronto para controle de visitantes!",
                                "Sucesso", JOptionPane.INFORMATION_MESSAGE);
                            
                            int abrirApp = JOptionPane.showConfirmDialog(this, 
                                "Deseja abrir o sistema de controle de visitantes agora?",
                                "Abrir Sistema", JOptionPane.YES_NO_OPTION);
                            
                            if (abrirApp == JOptionPane.YES_OPTION) {
                                dispose();
                                Main.launchMainApplication();
                            }
                        } else {
                            logMessage("‚ùå FALHA NA CRIA√á√ÉO DO BANCO");
                            JOptionPane.showMessageDialog(this, 
                                "Falha ao criar banco de dados EditPro.\n\n" +
                                "Poss√≠veis causas:\n" +
                                "‚Ä¢ Permiss√µes insuficientes no SQL Server\n" +
                                "‚Ä¢ Servidor n√£o est√° respondendo\n" +
                                "‚Ä¢ Banco j√° existe com conflitos",
                                "Erro na Cria√ß√£o", JOptionPane.ERROR_MESSAGE);
                        }
                    });
                    
                } catch (Exception ex) {
                    SwingUtilities.invokeLater(() -> {
                        logMessage("‚ùå ERRO CR√çTICO: " + ex.getMessage());
                        JOptionPane.showMessageDialog(this, 
                            "Erro durante a cria√ß√£o do banco:\n" + ex.getMessage(), 
                            "Erro", JOptionPane.ERROR_MESSAGE);
                    });
                }
            }).start();
        }
    }
    
    private void restaurarBackup(ActionEvent e) {
        String serverName = ConfigManager.getServerName();
        
        if (serverName == null || serverName.isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Servidor SQL n√£o configurado!\n\nConfigure primeiro a conex√£o com o SQL Server.", 
                "Erro", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        // Diret√≥rio inicial inteligente
        File initialDirectory = null;
        String[] possiblePaths = {
            "C:\\Program Files\\Microsoft SQL Server\\MSSQL15.SQLEXPRESS\\MSSQL\\Backup",
            "C:\\Program Files\\Microsoft SQL Server\\MSSQL14.SQLEXPRESS\\MSSQL\\Backup", 
            "C:\\Program Files\\Microsoft SQL Server\\MSSQL13.SQLEXPRESS\\MSSQL\\Backup",
            "C:\\Program Files\\Microsoft SQL Server\\MSSQL12.SQLEXPRESS\\MSSQL\\Backup",
            System.getProperty("user.home") + "\\Documents",
            System.getProperty("user.home") + "\\Desktop"
        };
        
        for (String path : possiblePaths) {
            File dir = new File(path);
            if (dir.exists() && dir.isDirectory()) {
                initialDirectory = dir;
                break;
            }
        }
        
        if (initialDirectory == null) {
            initialDirectory = new File(System.getProperty("user.home"));
        }
        
        JFileChooser fileChooser = new JFileChooser(initialDirectory);
        fileChooser.setDialogTitle("Selecionar Arquivo de Backup do EditPro (.bak)");
        fileChooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter("Backup SQL Server (*.bak)", "bak"));
        fileChooser.setApproveButtonText("Selecionar Backup");
        
        int result = fileChooser.showOpenDialog(this);
        if (result == JFileChooser.APPROVE_OPTION) {
            File backupFile = fileChooser.getSelectedFile();
            
            if (!backupFile.getName().toLowerCase().endsWith(".bak")) {
                JOptionPane.showMessageDialog(this, 
                    "O arquivo selecionado n√£o √© um backup v√°lido!\n\n" +
                    "Por favor, selecione um arquivo com extens√£o .bak",
                    "Arquivo Inv√°lido", JOptionPane.ERROR_MESSAGE);
                return;
            }
            
            int confirm = JOptionPane.showConfirmDialog(this, 
                "‚ö†Ô∏è CONFIRMAR RESTAURA√á√ÉO DO BACKUP ‚ö†Ô∏è\n\n" +
                "üìÅ ARQUIVO: " + backupFile.getName() + "\n" +
                "üìä SERVIDOR: " + serverName + "\n" +
                "üíæ BANCO: EditPro\n\n" +
                "üö® ATEN√á√ÉO: Esta a√ß√£o substituir√° completamente\n" +
                "o banco EditPro atual se existir!\n\n" +
                "Deseja continuar?",
                "Confirmar Restaura√ß√£o", 
                JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE);
            
            if (confirm == JOptionPane.YES_OPTION) {
                new Thread(() -> {
                    try {
                        logMessage("\n" + "=".repeat(50));
                        logMessage("INICIANDO RESTAURA√á√ÉO DO BACKUP");
                        logMessage("=".repeat(50));
                        logMessage("Arquivo: " + backupFile.getAbsolutePath());
                        logMessage("Servidor: " + serverName);
                        logMessage("üì¶ Iniciando processo de restaura√ß√£o...");
                        
                        DatabaseInitializer initializer = new DatabaseInitializer();
                        boolean success = initializer.restoreDatabase(backupFile.getAbsolutePath());
                        
                        SwingUtilities.invokeLater(() -> {
                            if (success) {
                                logMessage("‚úÖ BACKUP RESTAURADO COM SUCESSO!");
                                logMessage("‚úÖ Banco EditPro restaurado e pronto");
                                logMessage("‚úÖ Todos os dados foram importados");
                                
                                JOptionPane.showMessageDialog(this, 
                                    "‚úÖ BACKUP RESTAURADO COM SUCESSO!\n\n" +
                                    "O banco EditPro foi completamente restaurado\n" +
                                    "a partir do arquivo de backup.\n\n" +
                                    "Todos os dados est√£o dispon√≠veis para uso.",
                                    "Restaura√ß√£o Bem-sucedida", 
                                    JOptionPane.INFORMATION_MESSAGE);
                                
                                int abrirApp = JOptionPane.showConfirmDialog(this, 
                                    "Deseja abrir o sistema de controle de visitantes agora?",
                                    "Abrir Sistema", JOptionPane.YES_NO_OPTION);
                                
                                if (abrirApp == JOptionPane.YES_OPTION) {
                                    dispose();
                                    Main.launchMainApplication();
                                }
                            } else {
                                logMessage("‚ùå FALHA NA RESTAURA√á√ÉO");
                                JOptionPane.showMessageDialog(this, 
                                    "Falha ao restaurar o backup.\n\n" +
                                    "Poss√≠veis causas:\n" +
                                    "‚Ä¢ Arquivo de backup corrompido\n" +
                                    "‚Ä¢ Permiss√µes insuficientes\n" +
                                    "‚Ä¢ Vers√£o incompat√≠vel do SQL Server\n" +
                                    "‚Ä¢ Banco em uso por outro processo",
                                    "Erro na Restaura√ß√£o", 
                                    JOptionPane.ERROR_MESSAGE);
                            }
                        });
                        
                    } catch (Exception ex) {
                        SwingUtilities.invokeLater(() -> {
                            logMessage("‚ùå ERRO NA RESTAURA√á√ÉO: " + ex.getMessage());
                            JOptionPane.showMessageDialog(this, 
                                "Erro durante a restaura√ß√£o:\n" + ex.getMessage(), 
                                "Erro", JOptionPane.ERROR_MESSAGE);
                        });
                    }
                }).start();
            }
        }
    }
    
    private void verificarBanco(ActionEvent e) {
        String serverName = ConfigManager.getServerName();
        
        if (serverName == null || serverName.isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Servidor SQL n√£o configurado!", "Erro", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        new Thread(() -> {
            try {
                logMessage("\n" + "=".repeat(50));
                logMessage("VERIFICANDO STATUS DO BANCO EDITPRO");
                logMessage("=".repeat(50));
                
                // Testa conex√£o com o servidor
                logMessage("üîå Testando conex√£o com servidor...");
                boolean serverOk = ConnectionFactory.testConnection(serverName);
                
                if (!serverOk) {
                    logMessage("‚ùå Servidor n√£o est√° acess√≠vel");
                    SwingUtilities.invokeLater(() -> {
                        JOptionPane.showMessageDialog(this, 
                            "Servidor SQL n√£o est√° respondendo.", 
                            "Erro de Conex√£o", JOptionPane.ERROR_MESSAGE);
                    });
                    return;
                }
                
                logMessage("‚úÖ Servidor conectado com sucesso");
                
                // Testa conex√£o com o banco EditPro
                logMessage("üóÉÔ∏è Verificando banco EditPro...");
                boolean databaseExists = testEditProDatabase(serverName);
                
                SwingUtilities.invokeLater(() -> {
                    if (databaseExists) {
                        logMessage("‚úÖ Banco EditPro encontrado e acess√≠vel");
                        logMessage("‚úÖ Sistema est√° configurado corretamente");
                        
                        JOptionPane.showMessageDialog(this,
                            "‚úÖ STATUS DO SISTEMA: OK\n\n" +
                            "üìä Servidor: " + serverName + "\n" +
                            "üóÉÔ∏è Banco: EditPro (Acess√≠vel)\n" +
                            "üöÄ Sistema: Pronto para uso\n\n" +
                            "O sistema est√° configurado corretamente\n" +
                            "e pronto para controle de visitantes.",
                            "Verifica√ß√£o Conclu√≠da",
                            JOptionPane.INFORMATION_MESSAGE);
                    } else {
                        logMessage("‚ùå Banco EditPro n√£o encontrado");
                        logMessage("üí° Use 'Criar Novo Banco' para configurar");
                        
                        JOptionPane.showMessageDialog(this,
                            "‚ö†Ô∏è BANCO N√ÉO ENCONTRADO\n\n" +
                            "O banco EditPro n√£o existe ou n√£o est√° acess√≠vel.\n\n" +
                            "Para usar o sistema, voc√™ precisa:\n" +
                            "1. Criar um novo banco EditPro, OU\n" +
                            "2. Restaurar de um backup existente",
                            "Banco N√£o Encontrado",
                            JOptionPane.WARNING_MESSAGE);
                    }
                });
                
            } catch (Exception ex) {
                SwingUtilities.invokeLater(() -> {
                    logMessage("‚ùå ERRO NA VERIFICA√á√ÉO: " + ex.getMessage());
                    JOptionPane.showMessageDialog(this,
                        "Erro durante a verifica√ß√£o:\n" + ex.getMessage(),
                        "Erro", JOptionPane.ERROR_MESSAGE);
                });
            }
        }).start();
    }
    
    private boolean testEditProDatabase(String serverName) {
        String url = "jdbc:sqlserver://" + serverName.replace("\\", "\\\\") + 
                    ";databaseName=EditPro;integratedSecurity=true;trustServerCertificate=true;loginTimeout=5";
        
        try (java.sql.Connection conn = java.sql.DriverManager.getConnection(url)) {
            return true;
        } catch (java.sql.SQLException e) {
            return false;
        }
    }
    
    private void logMessage(String message) {
        SwingUtilities.invokeLater(() -> {
            logArea.append(message + "\n");
            logArea.setCaretPosition(logArea.getDocument().getLength());
        });
    }
}